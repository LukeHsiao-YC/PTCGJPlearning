<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢å¡ç‰Œå°è€å¸«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 2px, transparent 2px);
            background-size: 30px 30px;
        }
        .poke-shadow {
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // ä½ çš„å°ˆå±¬é‡‘é‘°
        const defaultApiKey = "AIzaSyCQV-S_JoGbiNHo-n2k-6yh0uWjmAsCM4k";

        // å¹«ç…§ç‰‡ç˜¦èº«çš„å°å·¥å…·ï¼ŒåŠ å¿« API å‚³é€é€Ÿåº¦
        const compressImage = (dataUrl, maxWidth) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // å£“ç¸®æˆ 70% ç•«è³ªçš„ JPEGï¼Œå° AI è¾¨è­˜æ–‡å­—ä¾†èªªå·²ç¶“å¤ æ¸…æ¥šäº†
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                };
                img.src = dataUrl;
            });
        };

        function App() {
            const [userApiKey, setUserApiKey] = useState('');
            const [isConfiguring, setIsConfiguring] = useState(!defaultApiKey);

            const [appState, setAppState] = useState('idle');
            const [words, setWords] = useState([]);
            const [capturedImage, setCapturedImage] = useState(null);
            const [errorMessage, setErrorMessage] = useState('');
            
            const fileInputRef = useRef(null);

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setAppState('analyzing');
                setErrorMessage('');

                const reader = new FileReader();
                reader.onloadend = async () => {
                    const originalDataUrl = reader.result;
                    
                    try {
                        // è®€å–å®Œç…§ç‰‡å¾Œï¼Œå…ˆæŠŠå®ƒç¸®å°åˆ°æœ€å¤§å¯¬åº¦ 800pxï¼Œå¤§å¹…æ¸›å°‘æª”æ¡ˆå¤§å°
                        const compressedDataUrl = await compressImage(originalDataUrl, 800);
                        setCapturedImage(compressedDataUrl);
                        
                        const base64Data = compressedDataUrl.split(',')[1];
                        analyzeCard(base64Data);
                    } catch (e) {
                        console.error("åœ–ç‰‡å£“ç¸®å¤±æ•—", e);
                        setErrorMessage("å“å‘€ï¼è™•ç†ç…§ç‰‡æ™‚é‡åˆ°ä¸€é»å•é¡Œï¼Œæ›ä¸€å¼µè©¦è©¦çœ‹å¥½å—ï¼Ÿ");
                        setAppState('error');
                    }
                };
                
                reader.onerror = () => {
                    setErrorMessage("å“å‘€ï¼ç…§ç‰‡è®€å–å¤±æ•—äº†ï¼Œæˆ‘å€‘æ›ä¸€å¼µè©¦è©¦çœ‹å¥½å—ï¼Ÿ");
                    setAppState('error');
                };

                reader.readAsDataURL(file);
                event.target.value = '';
            };

            const analyzeCard = async (base64Image) => {
                try {
                    // æ›´æ–°äº†æŒ‡ä»¤ï¼Œè¦æ±‚æŠ“åå­—è·Ÿæ‹›å¼ï¼Œé‚„æœ‰æŠŠç¾…é¦¬æ‹¼éŸ³åˆ†é–‹
                    const prompt = `
                        é€™æ˜¯ä¸€å¼µæ—¥æ–‡å¯¶å¯å¤¢å¡ç‰Œã€‚ä½ æ˜¯ä¸€å€‹å……æ»¿ç†±æƒ…ã€å°ˆé–€æ•™å°å­©æ—¥æ–‡çš„è€å¸«ã€‚
                        è«‹å¾é€™å¼µå¡ç‰Œä¸­æ“·å–ä»¥ä¸‹å…§å®¹ä¾†è®“å°å­©å­¸ç¿’ï¼Œä¸¦ä»¥ JSON æ ¼å¼çš„é™£åˆ—å›å‚³ï¼š
                        1. ç¬¬ä¸€ç­†è³‡æ–™å‹™å¿…è¦æŠ“å–ã€Œå¯¶å¯å¤¢çš„åç¨±ã€ã€‚
                        2. æ¥ä¸‹ä¾†è«‹æŠ“å– 1 åˆ° 2 å€‹ã€Œæ‹›å¼åç¨±ã€(Moves/Attacks)ã€‚
                        æ³¨æ„ï¼šç‚ºäº†è®“åˆå­¸è€…å°å­©èƒ½è·Ÿè‘—å”¸ï¼Œç¾…é¦¬æ‹¼éŸ³ (romaji) å¿…é ˆæŠŠæ¯å€‹å‡åçš„ç™¼éŸ³ç”¨ã€Œç©ºæ ¼ã€åˆ‡é–‹ï¼Œä¾‹å¦‚æŠŠ pikachu å¯«æˆ pi ka chuã€‚
                    `;

                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                            ]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        word: { type: "STRING", description: "å¯¶å¯å¤¢åç¨±æˆ–æ‹›å¼åç¨±" },
                                        kana: { type: "STRING", description: "å¹³å‡åè®€éŸ³" },
                                        romaji: { type: "STRING", description: "ç¾…é¦¬æ‹¼éŸ³ï¼Œæ¯å€‹å­—å…ƒç™¼éŸ³è«‹ç”¨ç©ºæ ¼åˆ†é–‹ï¼Œä¾‹å¦‚: pi ka chu" },
                                        meaning: { type: "STRING", description: "ç¹é«”ä¸­æ–‡æ„æ€" }
                                    },
                                    required: ["word", "kana", "romaji", "meaning"]
                                }
                            }
                        }
                    };

                    const activeApiKey = defaultApiKey || userApiKey;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${activeApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.error?.message || response.statusText || 'æœªçŸ¥å•é¡Œ';
                        if (response.status === 400 || response.status === 403) {
                            throw new Error("é‡‘é‘°å¥½åƒæœ‰é»å•é¡Œï¼Œè«‹æª¢æŸ¥æ˜¯ä¸æ˜¯è¤‡è£½éŒ¯äº†å–”ï¼");
                        }
                        throw new Error(`é€£ç·šéŒ¯èª¤ (${response.status}): ${errorMsg}`);
                    }

                    const data = await response.json();
                    
                    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (resultText) {
                        const parsedWords = JSON.parse(resultText);
                        setWords(parsedWords);
                        setAppState('result');
                    } else {
                        throw new Error("AI æœ‰å›è¦†ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°è¾¨è­˜çš„å–®å­—ã€‚");
                    }

                } catch (err) {
                    console.error("åˆ†æå¤±æ•—:", err);
                    setErrorMessage(`ç³»çµ±èªªï¼š${err.message}`);
                    setAppState('error');
                }
            };

            const resetApp = () => {
                setWords([]);
                setCapturedImage(null);
                setAppState('idle');
            };

            const saveConfig = () => {
                if (userApiKey.trim() !== '') {
                    setIsConfiguring(false);
                } else {
                    alert('è«‹å…ˆè¼¸å…¥é‡‘é‘°æ‰èƒ½é–‹å§‹å–”ï¼');
                }
            };

            const speakWord = (word) => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'ja-JP'; 
                    utterance.rate = 0.8;     
                    utterance.pitch = 1.1;    
                    
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert("å“å‘€ï¼ä½ çš„ç€è¦½å™¨å¥½åƒä¸æ”¯æ´ç™¼éŸ³åŠŸèƒ½å–”ã€‚");
                }
            };

            if (isConfiguring) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-3xl p-8 poke-shadow border-4 border-yellow-400 relative overflow-hidden">
                            <div className="text-center mb-6">
                                <h1 className="text-2xl font-black text-blue-600 tracking-wider mb-2">
                                    ğŸ”‘ å•Ÿå‹•å°è€å¸«
                                </h1>
                                <p className="text-gray-600 text-sm">
                                    ç‚ºäº†è®“ AI å°è€å¸«çœ‹æ‡‚å¡ç‰Œï¼Œè«‹å…ˆè¼¸å…¥ä½ çš„ Gemini API é‡‘é‘°ã€‚
                                </p>
                            </div>

                            <input 
                                type="password" 
                                placeholder="è«‹è²¼ä¸Šä½ çš„ API é‡‘é‘°..." 
                                className="w-full border-2 border-gray-300 rounded-xl p-4 mb-6 focus:border-blue-500 focus:outline-none font-mono text-sm"
                                value={userApiKey}
                                onChange={(e) => setUserApiKey(e.target.value)}
                            />

                            <button 
                                onClick={saveConfig}
                                className="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-4 rounded-full text-lg transition-transform active:scale-95 shadow-md mb-4"
                            >
                                å„²å­˜ä¸¦é–‹å§‹æƒæ
                            </button>

                            <div className="text-center mt-6">
                                <a 
                                    href="https://aistudio.google.com/app/apikey" 
                                    target="_blank" 
                                    rel="noreferrer"
                                    className="text-sm text-blue-500 hover:text-blue-700 underline font-bold"
                                >
                                    ä¸çŸ¥é“å»å“ªè£¡ç”³è«‹ï¼Ÿé»æˆ‘å…è²»å–å¾—é‡‘é‘°
                                </a>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    
                    <div className="max-w-md w-full bg-white rounded-3xl p-6 poke-shadow border-4 border-yellow-400 relative overflow-hidden">
                        
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-black text-blue-600 tracking-wider">
                                å¯¶å¯å¤¢æƒææ©Ÿ
                            </h1>
                            <p className="text-gray-500 text-sm mt-1">ä¸Šå‚³æ¸…æ¥šçš„ç…§ç‰‡è®“å°è€å¸«çœ‹çœ‹å§</p>
                        </div>

                        {appState === 'idle' && (
                            <div className="flex flex-col items-center justify-center py-8">
                                <div className="w-40 h-40 bg-blue-50 rounded-full flex items-center justify-center mb-8 border-4 border-dashed border-blue-200">
                                    <i data-lucide="image-plus" className="w-16 h-16 text-blue-300"></i>
                                </div>

                                <input 
                                    type="file" 
                                    accept="image/*" 
                                    capture="environment"
                                    className="hidden" 
                                    ref={fileInputRef}
                                    onChange={handleImageUpload}
                                />

                                <button 
                                    onClick={() => fileInputRef.current?.click()}
                                    className="w-full bg-red-500 hover:bg-red-600 active:bg-red-700 text-white font-bold py-4 rounded-full text-xl transition-transform active:scale-95 shadow-lg flex items-center justify-center gap-2"
                                >
                                    <i data-lucide="camera" className="w-6 h-6"></i>
                                    æ‹ç…§æˆ–é¸ç…§ç‰‡
                                </button>
                            </div>
                        )}

                        {appState === 'analyzing' && (
                            <div className="flex flex-col items-center justify-center py-12">
                                <div className="w-20 h-20 border-8 border-gray-200 border-t-red-500 rounded-full animate-spin mb-6"></div>
                                <h2 className="text-xl font-bold text-gray-700 animate-pulse">å°è€å¸«æ­£åœ¨çœ‹å¡ç‰Œ...</h2>
                                <p className="text-gray-500 mt-2">å°‹æ‰¾å¯¶å¯å¤¢è·Ÿå¸¥æ°£çš„æ‹›å¼ä¸­ï¼</p>
                            </div>
                        )}

                        {appState === 'result' && (
                            <div className="animate-fade-in flex flex-col items-center">
                                <div className="w-32 h-32 rounded-xl overflow-hidden mb-6 border-4 border-yellow-300 shadow-md">
                                    <img src={capturedImage} alt="Captured Card" className="w-full h-full object-cover" />
                                </div>
                                
                                <div className="w-full space-y-4">
                                    {words.map((item, index) => (
                                        <div key={index} className="bg-blue-50 rounded-2xl p-4 border-2 border-blue-100 relative group hover:bg-blue-100 transition-colors">
                                            
                                            {/* ç™¼éŸ³æŒ‰éˆ• */}
                                            <button 
                                                onClick={() => speakWord(item.word)}
                                                className="absolute -top-3 -right-3 bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md border-2 border-white hover:bg-red-600 active:scale-90 transition-transform cursor-pointer"
                                                title="è½ç™¼éŸ³"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                                </svg>
                                            </button>

                                            <div className="absolute -top-3 -left-3 bg-yellow-400 text-yellow-900 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm border-2 border-white">
                                                {index === 0 ? "å" : index}
                                            </div>

                                            <div className="text-center pt-2">
                                                <p className="text-blue-500 font-medium mb-1 tracking-widest">{item.kana}</p>
                                                <h3 className="text-3xl font-black text-gray-800 mb-1">{item.word}</h3>
                                                {/* è®“æ‹¼éŸ³å­—é«”ç¨å¾®å¤§ä¸€é»é»ï¼Œé–“è·ä¹Ÿæ‹‰é–‹ä¸€é»ï¼Œæ›´å¥½çœ‹æ¸…æ¥š */}
                                                <p className="text-gray-500 text-base font-mono mb-3 tracking-widest">{item.romaji}</p>
                                                <div className="inline-block bg-white px-4 py-1 rounded-full text-gray-600 font-bold border border-gray-200 shadow-sm">
                                                    {item.meaning}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <button 
                                    onClick={resetApp}
                                    className="mt-8 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-full text-lg transition-transform active:scale-95 shadow-lg"
                                >
                                    æƒæä¸‹ä¸€å¼µå¡ç‰Œï¼
                                </button>
                            </div>
                        )}

                        {appState === 'error' && (
                            <div className="text-center py-8">
                                <div className="text-5xl mb-4">ğŸ˜¢</div>
                                <p className="text-lg font-bold text-gray-700 mb-6 text-left break-words">{errorMessage}</p>
                                <button 
                                    onClick={resetApp}
                                    className="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-8 rounded-full shadow-sm"
                                >
                                    é‡æ–°è©¦è©¦çœ‹
                                </button>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        lucide.createIcons();
    </script>
</body>
</html>
